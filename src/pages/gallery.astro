---
import Layout from '~/layouts/PageLayout.astro';
import HeroText from '~/components/widgets/HeroText.astro';
import { createReader } from '@keystatic/core/reader';
import keystaticConfig from '../../keystatic.config';

export const prerender = true;

const reader = createReader(process.cwd(), keystaticConfig);

// Fetch gallery events metadata
const galleryEntries = await reader.collections.gallery.all();
const galleryEvents = galleryEntries
  .sort((a, b) => new Date(b.entry.eventDate).getTime() - new Date(a.entry.eventDate).getTime())
  .map((event) => ({
    name: event.entry.eventName,
    tag: event.entry.cloudinaryTag,
    date: new Date(event.entry.eventDate).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    }),
    description: event.entry.description,
  }));

const cloudName = import.meta.env.PUBLIC_CLOUDINARY_CLOUD_NAME || '';

const metadata = {
  title: 'Gallery',
};
---

<Layout metadata={metadata}>
  <HeroText
    tagline="Gallery"
    title="CSI - Innowave Gallery"
    subtitle="Capturing moments of innovation, learning, and community from our events and activities"
  />

  <!-- Gallery Container -->
  <section class="px-4 py-16 mx-auto max-w-7xl sm:px-6 lg:px-8">
    {
      galleryEvents.length === 0 ? (
        <div class="text-center py-12">
          <p class="text-xl text-gray-600 dark:text-gray-400">
            No gallery events added yet.
            .
          </p>
        </div>
      ) : (
        <div class="space-y-16">
          {galleryEvents.map((event) => (
            <div class="gallery-event" data-tag={event.tag} data-cloud-name={cloudName}>

              
              <!-- Loading State -->
              <div class="loading-state text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent"></div>
                <p class="mt-2 text-gray-600 dark:text-gray-400">Loading photos...</p>
              </div>

              <!-- Error State -->
              <div class="error-state hidden text-center py-8">
                <p class="text-red-600 dark:text-red-400">Failed to load photos. Please try again later.</p>
              </div>

              <!-- Images Grid -->
              <div class="images-grid hidden grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- Photos will be inserted here by JavaScript -->
              </div>
            </div>
          ))}
        </div>
      )
    }
  </section>

  <!-- Lightbox Modal -->
  <div
    id="lightbox"
    class="fixed inset-0 bg-black bg-opacity-90 z-50 hidden items-center justify-center p-4"
  >
    <button
      id="lightbox-close"
      class="absolute top-4 right-4 text-white text-4xl font-bold hover:text-gray-300 z-10"
      aria-label="Close lightbox"
    >
      &times;
    </button>

    <img id="lightbox-img" src="" alt="" class="max-w-full max-h-full object-contain" />
  </div>

  <script>
    interface CloudinaryResource {
      secure_url: string;
      public_id: string;
      width: number;
      height: number;
      context?: {
        custom?: {
          alt?: string;
          caption?: string;
        };
      };
    }

    interface CloudinaryResponse {
      resources: CloudinaryResource[];
    }

    // Fetch and display photos for each gallery event
    async function loadGalleryPhotos() {
      const events = document.querySelectorAll('.gallery-event');

      for (const eventEl of events) {
        const tag = eventEl.getAttribute('data-tag');
        const cloudName = eventEl.getAttribute('data-cloud-name');

        if (!cloudName) {
          const loadingState = eventEl.querySelector('.loading-state');
          if (loadingState) loadingState.classList.add('hidden');
          continue;
        }

        if (!tag) continue;

        try {
          const url = `/api/gallery/${tag}`;
          const response = await fetch(url);

          if (!response.ok) {
             const errData = await response.json();
             throw new Error(errData.error || `Failed to fetch: ${response.status}`);
          }

          const data: CloudinaryResponse = await response.json();
          const imagesGrid = eventEl.querySelector('.images-grid');
          const loadingState = eventEl.querySelector('.loading-state');

          if (data.resources && data.resources.length > 0) {
            if (imagesGrid) {
              imagesGrid.innerHTML = '';
              
              data.resources.forEach((resource, index) => {
                const imgWrapper = document.createElement('div');
                imgWrapper.className = 'relative overflow-hidden rounded-lg shadow-md hover:shadow-xl transition-shadow cursor-pointer group opacity-0 transition-opacity duration-500 ease-in-out';
                imgWrapper.setAttribute('data-index', index.toString());
                imgWrapper.setAttribute('data-full-url', resource.secure_url);

                const thumbnailUrl = resource.secure_url.replace('/upload/', '/upload/w_400,h_400,c_fill,g_auto/');

                imgWrapper.innerHTML = `
                  <img
                    src="${thumbnailUrl}"
                    alt="${resource.context?.custom?.alt || `Photo ${index + 1}`}"
                    class="w-full h-64 object-cover transition-transform group-hover:scale-110"
                    loading="lazy"
                  />
                  <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-opacity"></div>
                `;

                imagesGrid.appendChild(imgWrapper);
                
                setTimeout(() => {
                    imgWrapper.classList.remove('opacity-0');
                    imgWrapper.classList.add('opacity-100');
                }, 50 * index);
              });

              // Show grid, hide loading
              imagesGrid.classList.remove('hidden');
            }
            if (loadingState) loadingState.classList.add('hidden');

            // Store all images for lightbox
            eventEl.setAttribute('data-images', JSON.stringify(data.resources));
          } else {
            // No images found
            if (loadingState) {
              const loadingText = loadingState.querySelector('p');
              if (loadingText) {
                loadingText.textContent = `No photos found for tag "${tag}"`;
              }
            }
          }
        } catch (error: any) {
          console.error(`Error loading photos for ${tag}:`, error);
          const loadingState = eventEl.querySelector('.loading-state');
          const errorState = eventEl.querySelector('.error-state');
          if (loadingState) loadingState.classList.add('hidden');
          if (errorState) {
            errorState.classList.remove('hidden');
            const errorText = errorState.querySelector('p');
            if (errorText) errorText.textContent = error.message;
          }
        }
      }
    }

    // Lightbox functionality
    let currentEventImages: CloudinaryResource[] = [];
    let currentImageIndex = 0;

    function openLightbox(event: Event) {
      const target = event.currentTarget as HTMLElement;
      const index = parseInt(target.getAttribute('data-index') || '0');
      const eventEl = target.closest('.gallery-event');
      
      if (!eventEl) return;

      const imagesData = eventEl.getAttribute('data-images');
      if (!imagesData) return;

      currentEventImages = JSON.parse(imagesData);
      currentImageIndex = index;
      
      showLightboxImage();
      
      const lightbox = document.getElementById('lightbox');
      if (lightbox) {
        lightbox.classList.remove('hidden');
        lightbox.classList.add('flex');
      }
    }

    function showLightboxImage() {
      const img = document.getElementById('lightbox-img') as HTMLImageElement;
      if (img && currentEventImages[currentImageIndex]) {
        const resource = currentEventImages[currentImageIndex];
        // Full quality image
        img.src = resource.secure_url;
        img.alt = resource.context?.custom?.alt || `Photo ${currentImageIndex + 1}`;
      }
    }

    function closeLightbox() {
      const lightbox = document.getElementById('lightbox');
      if (lightbox) {
        lightbox.classList.add('hidden');
        lightbox.classList.remove('flex');
      }
    }



    // Event listeners
    document.addEventListener('astro:page-load', () => {
      loadGalleryPhotos();

      // Lightbox controls
      document.getElementById('lightbox-close')?.addEventListener('click', closeLightbox);

      
      document.getElementById('lightbox')?.addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeLightbox();
      });

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        const lightbox = document.getElementById('lightbox');
        if (lightbox && !lightbox.classList.contains('hidden')) {
          if (e.key === 'Escape') closeLightbox();

        }
      });

      // Delegate click events for images
      document.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        const imgWrapper = target.closest('[data-index]');
        if (imgWrapper && imgWrapper.closest('.images-grid')) {
          openLightbox({ currentTarget: imgWrapper } as any);
        }
      });
    });
  </script>
</Layout>
